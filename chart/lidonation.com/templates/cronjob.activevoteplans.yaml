apiVersion: batch/v1beta1
kind: CronJob
metadata:
  namespace: {{ .Values.namespace }}
  name: "{{ $.Chart.Name }}-activevoteplans"
spec:
  schedule: "*/2 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
            - name: "{{ $.Chart.Name }}-catalyst-utils-pv"
              persistentVolumeClaim:
                claimName: "{{ .Values.namespace }}-catalyst-utils-pvc"          
          initContainers:
            - name: fetch-archive
              image: bitnami/kubectl:1.24.9-debian-11-r10
              imagePullPolicy: IfNotPresent
              volumeMounts:
                - name: "{{ $.Chart.Name }}-catalyst-utils-pv"
                  mountPath: /leader1stuff
              command:
                - "/bin/sh"
                - "-c"
                - |
                  sudo apt install curl
                  sudo apt install zstd
                  LATEST_ARCHIVE_ID_FROM_LIDO=$(curl -s https://www.lidonation.com/api/catalyst-explorer/ledger-snapshots/latest | jq -r '.data.snapshot_id')
                  URL=$(curl -s https://archiver.projectcatalyst.io/api/v1/archives/$LATEST_ARCHIVE_ID_FROM_LIDO/download | jq -r .url)
                  curl -o /leader1stuff/archive.tar.zstd "$URL"
                  zstd -d /leader1stuff/archive.tar.zstd
                  tar -xvf /leader1stuff/archive.tar
                  mkdir -p /leader1stuff/persist
                  mkdir -p /leader1stuff/persist/leader-1
                  rm -rf /leader1stuff/volatile /leader1stuff/permanent /leader1stuff/artifacts
                  mv volatile permanent  /leader1stuff/persist/leader-1/
                  mv artifacts /leader1stuff/ 
                  rm -f /leader1stuff/archive.tar.zstd /leader1stuff/archive.tar
                  echo "All set..."
          containers:
            - name: jormungandr
              image: registry.lidonation.com/lidonation/lidonation/jormungandr:fund10
              volumeMounts:
                - name: "{{ $.Chart.Name }}-catalyst-utils-pv"
                  mountPath: /leader1stuff
              env:
                - name: STORAGE_PATH
                  value: /leader1stuff/persist/leader-1
                - name: GENESIS_PATH
                  value: /leader1stuff/artifacts/block0.bin
            - name: query-api
              image: bitnami/kubectl:1.24.9-debian-11-r10
              imagePullPolicy: IfNotPresent
              volumeMounts:
                - name: "{{ $.Chart.Name }}-catalyst-utils-pv"
                  mountPath: /leader1stuff
              command:
                - "/bin/sh"
                - "-c"
                - |
                  sleep 5m
                  curl http://127.0.0.1:10000/api/v0/vote/active/plans
                  if [[ $? -ne 0 ]]; then
                    echo "Failed to get the active vote plans."
                    exit 1
                  fi
                  curl http://127.0.0.1:10000/api/v0/vote/active/plans > /leader1stuff/activevoteplans.json
          imagePullSecrets:
            - name: {{ .Values.image.pullSecret }}
          restartPolicy: Never    
